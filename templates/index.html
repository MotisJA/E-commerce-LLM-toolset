<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI智能人脉助手</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://lf3-static.bytednsdoc.com/obj/eden-cn/veh7vhpeps/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="app-container">
        <nav class="top-nav">
            <div class="nav-content">
                <div class="logo">
                    <i class="fas fa-network-wired"></i>
                    <span>AI智能人脉助手</span>
                </div>
            </div>
        </nav>

        <main class="main-content">
            <!-- 添加营销方案标签页 -->
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="search">专家匹配</button>
                <button class="tab-btn" data-tab="marketing">营销方案</button>
                <button class="tab-btn" data-tab="inventory">库存管理</button>
            </div>
            
            <!-- 原有的搜索section包装在tab-content中 -->
            <div id="search-tab" class="tab-content active">
                <div class="search-section">
                    <h1>发现您的理想商业伙伴</h1>
                    <p class="subtitle">输入关键词，AI助手帮您寻找最匹配的行业专家</p>
                    
                    <form id="name-form" class="search-form">
                        <div class="input-group">
                            <i class="fas fa-search"></i>
                            <input type="text" id="flower" name="flower" 
                                   placeholder="输入关键词（如：鲜花、科技、教育等）">
                            <button id="magic-button" type="submit">
                                <i class="fas fa-magic"></i>
                                开始匹配
                            </button>
                        </div>
                    </form>
                </div>

                <div id="result" class="result-section" style="display:none">
                    <div class="profile-card">
                        <div class="profile-header">
                            <img id="profile-pic" src="" alt="Profile Picture">
                            <span class="verified-badge">
                                <i class="fas fa-check-circle"></i>
                                已认证专家
                            </span>
                        </div>

                        <div class="info-grid">
                            <div class="info-card">
                                <div class="card-header">
                                    <i class="fas fa-user-circle"></i>
                                    <h2>基本情况</h2>
                                </div>
                                <div id="summary" class="card-content"></div>
                            </div>

                            <div class="info-card">
                                <div class="card-header">
                                    <i class="fas fa-star"></i>
                                    <h2>特色内容</h2>
                                </div>
                                <div id="facts" class="card-content"></div>
                            </div>

                            <div class="info-card">
                                <div class="card-header">
                                    <i class="fas fa-lightbulb"></i>
                                    <h2>共同话题</h2>
                                </div>
                                <div id="interest" class="card-content"></div>
                            </div>

                            <div class="info-card full-width">
                                <div class="card-header">
                                    <i class="fas fa-envelope"></i>
                                    <h2>推荐邮件模板</h2>
                                </div>
                                <div id="letter" class="card-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 新增营销方案tab -->
            <div id="marketing-tab" class="tab-content">
                <div class="marketing-section">
                    <h1>AI营销方案助手</h1>
                    <p class="subtitle">输入产品信息,AI为您定制专业营销方案</p>
                    
                    <form id="marketing-form" class="marketing-form">
                        <div class="input-group">
                            <input type="text" id="product" name="product" 
                                   placeholder="目标产品/服务">
                        </div>
                        <div class="input-group">
                            <input type="text" id="target" name="target" 
                                   placeholder="目标受众群体">
                        </div>
                        <div class="input-group">
                            <input type="text" id="goal" name="goal" 
                                   placeholder="营销目标">
                        </div>
                        <button type="submit">
                            <i class="fas fa-lightbulb"></i>
                            生成方案
                        </button>
                    </form>
                </div>

                <div id="marketing-result" class="marketing-result" style="display:none">
                    <div class="marketing-plan-card">
                        <h2>营销方案建议</h2>
                        <div id="plan-content"></div>
                        
                        <div class="feedback-section">
                            <h3>优化建议</h3>
                            <textarea id="feedback" placeholder="请输入您的反馈意见..."></textarea>
                            <button onclick="refinePlan()">
                                <i class="fas fa-sync"></i>
                                优化方案
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 在已有的tab-content后添加库存管理tab -->
            <div id="inventory-tab" class="tab-content">
                <div class="inventory-section">
                    <h1>AI智能库存管理</h1>
                    <p class="subtitle">输入产品信息，AI助手帮您优化库存策略</p>
                    
                    <form id="inventory-form" class="inventory-form">
                        <div class="input-group">
                            <input type="text" id="inv-product" name="product" 
                                   placeholder="产品名称">
                        </div>
                        <div class="input-group">
                            <input type="number" id="current-stock" name="current_stock" 
                                   placeholder="当前库存量">
                        </div>
                        <button type="submit">
                            <i class="fas fa-boxes"></i>
                            分析库存
                        </button>
                    </form>
                </div>

                <div id="inventory-result" class="inventory-result" style="display:none">
                    <div class="inventory-analysis-card">
                        <div class="card-section">
                            <h2><i class="fas fa-chart-line"></i> 影响因素分析</h2>
                            <div class="factors-grid">
                                <div class="factor-card">
                                    <h3>天气影响</h3>
                                    <div id="weather-impact"></div>
                                </div>
                                <div class="factor-card">
                                    <h3>社交趋势</h3>
                                    <div id="social-trends"></div>
                                </div>
                                <div class="factor-card">
                                    <h3>节假日效应</h3>
                                    <div id="seasonal-events"></div>
                                </div>
                            </div>
                        </div>

                        <div class="card-section">
                            <h2><i class="fas fa-warehouse"></i> 库存策略建议</h2>
                            <div id="inventory-strategy"></div>
                        </div>

                        <div class="card-section">
                            <h2><i class="fas fa-truck"></i> 物流配送方案</h2>
                            <div id="logistics-plan"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="loading-overlay" id="spinner-container" style="display: none;">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <span>正在匹配最佳专家...</span>
        </div>
    </div>

    <!-- 添加客服聊天窗口 -->
    <div class="chat-container" id="chatWindow">
        <div class="chat-header">
            <i class="fas fa-headset"></i>
            <span>智能客服</span>
            <button class="minimize-btn" onclick="toggleChat()">
                <i class="fas fa-minus"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="请输入您的问题...">
            <button onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            $('#name-form').on('submit', function (e) {
                e.preventDefault();
                $('#spinner-container').show();
                $('#result').hide();
                
                $.ajax({
                    url: '/process',
                    data: $('#name-form').serialize(),
                    type: 'POST',
                    success: function (response) {
                        $('#profile-pic').attr('src', 'https://media.licdn.com/dms/image/C5603AQFNBlle-yAc5g/profile-displayphoto-shrink_800_800/0/1517403045625?e=1702512000&v=beta&t=klKCelFxssjEw0Y1_3bmzP9YLy8yGijKz9_P16lGy5w'); 
                        $('#summary').text(response.summary);
                        $('#facts').html('<ul>' + response.facts.map(fact => '<li>' + fact + '</li>').join('') + '</ul>');
                        $('#interest').html('<ul>' + response.interest.map(interest => '<li>' + interest + '</li>').join('') + '</ul>');
                        $('#letter').text(response.letter[0]); // 注意这里修改为访问letter数组的第一个元素
                        $('#result').fadeIn();
                    },
                    error: function (error) {
                        console.log(error);
                        alert('获取数据失败，请稍后重试');
                    },
                    complete: function () {
                        $('#spinner-container').hide();
                    }
                });
            });
        });

        function toggleChat() {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.classList.toggle('minimized');
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            appendMessage('user', message);
            input.value = '';

            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    appendMessage('error', data.error);
                } else {
                    appendMessage('bot', data.response);
                }
            })
            .catch(error => {
                appendMessage('error', '抱歉，服务暂时不可用');
            });
        }

        function appendMessage(type, content) {
            const messages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.textContent = content;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        // 支持按回车发送消息
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // 添加标签页切换逻辑
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                // 移除所有active类
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // 添加active类到当前标签
                button.classList.add('active');
                document.getElementById(`${button.dataset.tab}-tab`).classList.add('active');
            });
        });

        // 处理营销方案表单提交
        document.getElementById('marketing-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const data = {
                product: document.getElementById('product').value,
                target: document.getElementById('target').value,
                goal: document.getElementById('goal').value
            };
            
            $('#spinner-container').show();
            
            fetch('/marketing/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('plan-content').innerHTML = data.plan.replace(/\n/g, '<br>');
                document.getElementById('marketing-result').style.display = 'block';
            })
            .catch(error => {
                alert('生成方案失败，请稍后重试');
            })
            .finally(() => {
                $('#spinner-container').hide();
            });
        });

        // 方案优化功能
        function refinePlan() {
            const data = {
                plan: document.getElementById('plan-content').innerHTML.replace(/<br>/g, '\n'),
                feedback: document.getElementById('feedback').value
            };
            
            $('#spinner-container').show();
            
            fetch('/marketing/refine', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('plan-content').innerHTML = data.plan.replace(/\n/g, '<br>');
                document.getElementById('feedback').value = '';
            })
            .catch(error => {
                alert('优化方案失败，请稍后重试');
            })
            .finally(() => {
                $('#spinner-container').hide();
            });
        }

        // 添加库存管理表单处理
        document.getElementById('inventory-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const data = {
                product: document.getElementById('inv-product').value,
                current_stock: parseInt(document.getElementById('current-stock').value)
            };
            
            $('#spinner-container').show();
            
            fetch('/inventory/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                // 更新天气影响
                document.getElementById('weather-impact').innerHTML = formatFactors(data.factors.weather_impact);
                
                // 更新社交趋势
                document.getElementById('social-trends').innerHTML = formatFactors(data.factors.social_trends);
                
                // 更新节假日效应
                document.getElementById('seasonal-events').innerHTML = formatEvents(data.factors.seasonal_events);
                
                // 更新库存策略
                document.getElementById('inventory-strategy').innerHTML = formatStrategy(data.strategy);
                
                // 更新物流方案
                document.getElementById('logistics-plan').innerHTML = formatLogistics(data.logistics);
                
                // 显示结果
                document.getElementById('inventory-result').style.display = 'block';
            })
            .catch(error => {
                alert('分析库存失败，请稍后重试');
            })
            .finally(() => {
                $('#spinner-container').hide();
            });
        });

        // 格式化数据显示的辅助函数
        function formatFactors(factors) {
            return `
                <div class="factor-content">
                    <p><strong>影响程度:</strong> ${factors.impact}</p>
                    <p><strong>行为变化:</strong> ${factors.behavior_changes}</p>
                    <p><strong>需求预测:</strong> ${factors.demand_forecast}</p>
                    <p><strong>建议:</strong> ${factors.recommendations}</p>
                </div>
            `;
        }

        function formatEvents(events) {
            return events.map(event => `
                <div class="event-item">
                    <h4>${event.event}</h4>
                    <p>${event.impact.join('<br>')}</p>
                </div>
            `).join('');
        }

        function formatStrategy(strategy) {
            return `
                <ul class="strategy-list">
                    <li><strong>建议库存水平:</strong> ${strategy.suggested_level}</li>
                    <li><strong>补货时间点:</strong> ${strategy.reorder_time}</li>
                    <li><strong>安全库存量:</strong> ${strategy.safety_stock}</li>
                    <li><strong>其他建议:</strong> ${strategy.recommendations}</li>
                </ul>
            `;
        }

        function formatLogistics(logistics) {
            return `
                <ul class="logistics-list">
                    <li><strong>配送路线:</strong> ${logistics.routes}</li>
                    <li><strong>运力分配:</strong> ${logistics.resources}</li>
                    <li><strong>时效保障:</strong> ${logistics.timeliness}</li>
                    <li><strong>成本优化:</strong> ${logistics.cost_optimization}</li>
                </ul>
            `;
        }
    </script>
</body>
</html>
